class Bible {
    static Stats = {"Genesis":[31,25,24,26,32,22,24,22,29,32,32,20,18,24,21,16,27,33,38,18,34,24,20,67,34,35,46,22,35,43,55,32,20,31,29,43,36,30,23,23,57,38,34,34,28,34,31,22,33,26],"Exodus":[22,25,22,31,23,30,25,32,35,29,10,51,22,31,27,36,16,27,25,26,36,31,33,18,40,37,21,43,46,38,18,35,23,35,35,38,29,31,43,38],"Leviticus":[17,16,17,35,19,30,38,36,24,20,47,8,59,57,33,34,16,30,37,27,24,33,44,23,55,46,34],"Numbers":[54,34,51,49,31,27,89,26,23,36,35,16,33,45,41,50,13,32,22,29,35,41,30,25,18,65,23,31,40,16,54,42,56,29,34,13],"Deuteronomy":[46,37,29,49,33,25,26,20,29,22,32,32,18,29,23,22,20,22,21,20,23,30,25,22,19,19,26,68,29,20,30,52,29,12],"Joshua":[18,24,17,24,15,27,26,35,27,43,23,24,33,15,63,10,18,28,51,9,45,34,16,33],"Judges":[36,23,31,24,31,40,25,35,57,18,40,15,25,20,20,31,13,31,30,48,25],"Ruth":[22,23,18,22],"1 Samuel":[28,36,21,22,12,21,17,22,27,27,15,25,23,52,35,23,58,30,24,42,15,23,29,22,44,25,12,25,11,31,13],"2 Samuel":[27,32,39,12,25,23,29,18,13,19,27,31,39,33,37,23,29,33,43,26,22,51,39,25],"1 Kings":[53,46,28,34,18,38,51,66,28,29,43,33,34,31,34,34,24,46,21,43,29,53],"2 Kings":[18,25,27,44,27,33,20,29,37,36,21,21,25,29,38,20,41,37,37,21,26,20,37,20,30],"1 Chronicles":[54,55,24,43,26,81,40,40,44,14,47,40,14,17,29,43,27,17,19,8,30,19,32,31,31,32,34,21,30],"2 Chronicles":[17,18,17,22,14,42,22,18,31,19,23,16,22,15,19,14,19,34,11,37,20,12,21,27,28,23,9,27,36,27,21,33,25,33,27,23],"Ezra":[11,70,13,24,17,22,28,36,15,44],"Nehemiah":[11,20,32,23,19,19,73,18,38,39,36,47,31],"Esther":[22,23,15,17,14,14,10,17,32,3],"Job":[22,13,26,21,27,30,21,22,35,22,20,25,28,22,35,22,16,21,29,29,34,30,17,25,6,14,23,28,25,31,40,22,33,37,16,33,24,41,30,24,34,17],"Psalms":[6,12,8,8,12,10,17,9,20,18,7,8,6,7,5,11,15,50,14,9,13,31,6,10,22,12,14,9,11,12,24,11,22,22,28,12,40,22,13,17,13,11,5,26,17,11,9,14,20,23,19,9,6,7,23,13,11,11,17,12,8,12,11,10,13,20,7,35,36,5,24,20,28,23,10,12,20,72,13,19,16,8,18,12,13,17,7,18,52,17,16,15,5,23,11,13,12,9,9,5,8,28,22,35,45,48,43,13,31,7,10,10,9,8,18,19,2,29,176,7,8,9,4,8,5,6,5,6,8,8,3,18,3,3,21,26,9,8,24,13,10,7,12,15,21,10,20,14,9,6],"Proverbs":[33,22,35,27,23,35,27,36,18,32,31,28,25,35,33,33,28,24,29,30,31,29,35,34,28,28,27,28,27,33,31],"Ecclesiastes":[18,26,22,16,20,12,29,17,18,20,10,14],"Solomon":[17,17,11,16,16,13,13,14],"Isaiah":[31,22,26,6,30,13,25,22,21,34,16,6,22,32,9,14,14,7,25,6,17,25,18,23,12,21,13,29,24,33,9,20,24,17,10,22,38,22,8,31,29,25,28,28,25,13,15,22,26,11,23,15,12,17,13,12,21,14,21,22,11,12,19,12,25,24],"Jeremiah":[19,37,25,31,31,30,34,22,26,25,23,17,27,22,21,21,27,23,15,18,14,30,40,10,38,24,22,17,32,24,40,44,26,22,19,32,21,28,18,16,18,22,13,30,5,28,7,47,39,46,64,34],"Lamentations":[22,22,66,22,22],"Ezekiel":[28,10,27,17,17,14,27,18,11,22,25,28,23,23,8,63,24,32,14,49,32,31,49,27,17,21,36,26,21,26,18,32,33,31,15,38,28,23,29,49,26,20,27,31,25,24,23,35],"Daniel":[21,49,30,37,31,28,28,27,27,21,45,13],"Hosea":[11,23,5,19,15,11,16,14,17,15,12,14,16,9],"Joel":[20,32,21],"Amos":[15,16,15,13,27,14,17,14,15],"Jonah":[17,10,10,11],"Micah":[16,13,12,13,15,16,20],"Nahum":[15,13,19],"Habakkuk":[17,20,19],"Zephaniah":[18,15,20],"Haggai":[15,23],"Zechariah":[21,13,10,14,11,15,14,23,17,12,17,14,9,21],"Malachi":[14,17,18,6],"Matthew":[25,23,17,25,48,34,29,34,38,42,30,50,58,36,39,28,27,35,30,34,46,46,39,51,46,75,66,20],"Mark":[45,28,35,41,43,56,37,38,50,52,33,44,37,72,47,8],"Luke":[80,52,38,44,39,49,50,56,62,42,54,59,35,35,32,31,37,43,48,47,38,71,56,53],"John":[51,25,36,54,47,71,52,59,41,42,57,50,38,31,27,33,26,40,42,31,25],"Acts":[26,47,26,37,42,15,60,40,43,48,30,25,52,28,41,40,34,28,41,38,40,30,35,27,27,32,44,31],"Romans":[32,29,31,25,21,23,25,39,33,21,36,21,14,23,33,27],"1 Corinthians":[31,16,23,21,13,20,40,13,27,33,34,31,13,40,58,24],"2 Corinthians":[24,17,18,18,21,18,16,24,15,18,33,21,14],"Galatians":[24,21,29,31,26,18],"Ephesians":[23,22,21,32,33,24],"Philippians":[30,30,21,23],"Colossians":[29,23,25,18],"1 Thessalonians":[10,20,13,18,28],"2 Thessalonians":[12,17,18],"1 Timothy":[20,15,16,16,25,21],"2 Timothy":[18,26,17,22],"Titus":[16,15,15],"Hebrews":[14,18,19,16,14,20,28,13,28,39,40,29,25],"James":[27,26,18,17,20],"1 Peter":[25,25,22,19,14],"2 Peter":[21,22,18],"1 John":[10,29,24,21,21],"Revelation":[20,29,22,11,14,17,17,13,21,11,19,17,18,20,8,21,18,24,21,15,27,21]}
    static Books = {};

    static contentRegex = /(((([123]|\bI+|First|Second|Third)\s*)?[A-Z][a-z]+\.?)\s(\d+:\s*)((\d|[:.]\s*|;\s(?=\s*\d+:)|,\s*|-|(?:\s+\d+:))+))\b/g
    static regex = /((([123]|\bI+ |First|Second|Third)\s*)?[A-Z][a-z]+\.?)\s((\d|[:.]\s*|;\s(?=\s*\d+:)|,\s*|-|(?:\s+\d+:))+)/g;
    static regexVerses = /(\d+)[:;.]\s*((\d+)( ?[,-] ?)?(?!\d+:))+/g;
    static regexVersesSub = /(\d+)(\s*[,-]\s*)?/g;
    static regexGoesOverEnd = /(\d+):(\d+)-(\d+):(\d+)/g;

    static Fetch(books, callback){
        let needSearching = books.filter((b) => Bible.Books[b] == null);
        if (!needSearching.length){
            if(callback) callback();
            return;
        }
        let promises = [];
        let completions = 0;
        for (const book of needSearching){
            promises.push($.getJSON('js/nwt/' + book + ".json", function(data){
                Bible.Books[book] = data;
                // if(++completions === promises.length)
                //     if(callback) callback();
            }));
        }
        return $.when(...promises).then(function(){
            if(callback) callback();
        });
    }
    static GetBooksAndVersess(line){
        let matches = [...line.matchAll(this.regex)];

        let versesOnLine = 0;
        let bookDict = {};

        for(let i = 0; i < matches.length; i++)
        {
            let match = matches[i]

            let book = match[1].toLowerCase();
            book = BibleBooks.ComplexMatchBook(book);
            if (book === "") break;
            if (!book || book.length === 0)
            {
                break;
            }
            if(!bookDict[book])
                bookDict[book] = {};

            let bookChapters = this.Stats[book];

            let rawVerse = match[0].replace(/(^[-,"\s]|[-,"\s]$)/g, '').replace(/(:)\s*/, '$1').replace(';', ' ');
            if (bookChapters != null && bookChapters.length === 1 && rawVerse.indexOf(':') === -1)
            {
                rawVerse = rawVerse.replace(/^(\d*\s*\w+\.?)\s*/, "$1 1:");
            }

            if (rawVerse.match(/:/g).length > 1)
            {
                let overmatch;
                while((overmatch = this.regexGoesOverEnd.exec(rawVerse)) !== null)
                {
                    let startChapter = parseInt(overmatch[1]);
                    if (startChapter <= 0) { continue; }
                    let startVerse = parseInt(overmatch[2]);
                    let endChapter = parseInt(overmatch[3]);
                    let endVerse = parseInt(overmatch[4]);
                    if (endChapter > startChapter + 3) { continue; }
                    if (endChapter < startChapter) { continue; }
                    if (bookChapters == null) continue;
                    if (startChapter > bookChapters.length || endChapter > bookChapters.length) continue;
                    for (let c = startChapter; c <= endChapter; c++)
                    {
                        let maxVerse = c === endChapter ? Math.min(endVerse, bookChapters[c - 1]): bookChapters[c - 1];
                        for (let verse = startVerse; verse <= maxVerse; verse++)
                        {
                            if(!bookDict[book][c]) bookDict[book][c] = [];
                            bookDict[book][c].push(verse);
                        }
                        startVerse = 0;
                    }
                }
                rawVerse = rawVerse.replace(this.regexGoesOverEnd, "");
            }

            //if(verseGroups.Count > 1) { }
            let verseMatch;
            while((verseMatch = this.regexVerses.exec(rawVerse)) !== null)
            {
                var chapter = parseInt(verseMatch[1]);
                if (chapter <= 0) { continue; }
                if (bookChapters != null && chapter > bookChapters.length) continue;
                let startVerse = 99999;

                let versesPart = verseMatch[0].substr(verseMatch[0].indexOf(':') + 1);
                let subMatches = [...versesPart.matchAll(this.regexVersesSub)]
                for (let i = 0; i < subMatches.length; i++)
                {
                    let endVerse = parseInt(subMatches[i][1].trim());
                    let mode = (i === 0) ? ',' : subMatches[i - 1][2].trim();
                    if (mode === ',') startVerse = endVerse;
                    else startVerse++;
                    if (bookChapters != null && endVerse > bookChapters[chapter - 1]) continue;
                    if (endVerse - startVerse > 100) continue;
                    for (let v = startVerse; v <= endVerse; v++)
                    {
                        //let textVer = chapter + ":" + v;
                        if(!bookDict[book][chapter]) bookDict[book][chapter] = [];
                        bookDict[book][chapter].push(v);
                    }
                }
            }

        }

        return bookDict;
    }
}

class BibleBooks {
    static books = [
        "Genesis",
        "Exodus",
        "Leviticus",
        "Numbers",
        "Deuteronomy",
        "Joshua",
        "Judges",
        "Ruth",
        "1 Samuel",
        "2 Samuel",
        "1 Kings",
        "2 Kings",
        "1 Chronicles",
        "2 Chronicles",
        "Ezra",
        "Nehemiah",
        "Esther",
        "Job",
        "Psalms",
        "Proverbs",
        "Ecclesiastes",
        "Song of Solomon",
        "Isaiah",
        "Jeremiah",
        "Lamentations",
        "Ezekiel",
        "Daniel",
        "Hosea",
        "Joel",
        "Amos",
        "Obadiah",
        "Jonah",
        "Micah",
        "Nahum",
        "Habakkuk",
        "Zephaniah",
        "Haggai",
        "Zechariah",
        "Malachi",
        "Matthew",
        "Mark",
        "Luke",
        "John",
        "Acts",
        "Romans",
        "1 Corinthians",
        "2 Corinthians",
        "Galatians",
        "Ephesians",
        "Philippians",
        "Colossians",
        "1 Thessalonians",
        "2 Thessalonians",
        "1 Timothy",
        "2 Timothy",
        "Titus",
        "Philemon",
        "Hebrews",
        "James",
        "1 Peter",
        "2 Peter",
        "1 John",
        "2 John",
        "3 John",
        "Jude",
        "Revelation"
    ];
    static initd = false;
    static Init(){
        if(this.initd) return;
        this.initd = true;
        for(const value of Object.values(BibleBooks.conversion)){
            BibleBooks.conversion[value.toLowerCase()] = value;
        }
    }
    static GetBookAtIndex(index){
        return BibleBooks.books[index];
    }
    static GetIndexOfBook(book){
        let index = BibleBooks.books.indexOf(book);
        if(index === -1){
            console.error("Could not find index for Bible book " + book);
        }
        return index;
    }
    static ComplexMatchBook(book)
    {
        this.Init();
        book = book.replace(/\.+$/, '').toLowerCase();

        if (!book || book.length === 0) return null;
        book = book.replace(/\s+/, ' ');
        if (isNumeric(book.charAt(0)) && book.charAt(1) !== ' ')
            book = book[0] + " " + book.Substring(1);
        let exactMatch = this.conversion[book];
        if (exactMatch) return exactMatch;

        if(book.match(/^(i+) /)){
            book = book.replace(/^(i+) /, (match, match0)=>{
                return match0.length + " ";
            });
        }
        book = book.replace(/\s+/, " ");
        book = book.replace(/First/i, "1");
        book = book.replace(/Second/i, "2");
        book = book.replace(/Third/i, "3");

        exactMatch = this.conversion[book];
        if (exactMatch) return exactMatch;

        book = book.replace(/^[\d\s]*/, '');
        exactMatch = this.conversion[book];
        if (exactMatch) return exactMatch;

        return null;
    }

    static conversion = {
        "jude": "Jude",
        "1 tim": "1 Timothy",
        "2 tim": "2 Timothy",
        "1 ti": "1 Timothy",
        "2 ti": "2 Timothy",
        "matt": "Matthew",
        "mt": "Matthew",
        "mr": "Mark",
        "mk": "Mark",
        "ezra": "Ezra",
        "ezr": "Ezra",
        "ez": "Ezra",
        "esdras": "Ezra",
        "psalm": "Psalms",
        "1 psalm": "Psalms",
        "2 psalm": "Psalms",
        "3 psalm": "Psalms",
        "ps": "Psalms",
        "pss": "Psalms",
        "psa": "Psalms",
        "gen": "Genesis",
        "prov": "Proverbs",
        "ex": "Exodus",
        "exo": "Exodus",
        "lev": "Leviticus",
        "le": "Leviticus",
        "zech": "Zechariah",
        "zec": "Zechariah",
        "jas": "James",
        "ezek": "Ezekiel",
        "ezck": "Ezekiel",
        "eccl": "Ecclesiastes",
        "ecclus": "Ecclesiastes",
        "ec": "Ecclesiastes",
        "ecclesiasticus": "Ecclesiastes",
        "hag": "Haggai",
        "1 chron": "1 Chronicles",
        "2 chron": "2 Chronicles",
        "1 chro": "1 Chronicles",
        "2 chro": "2 Chronicles",
        "1 chr": "1 Chronicles",
        "2 chr": "2 Chronicles",
        "1 ch": "1 Chronicles",
        "2 ch": "2 Chronicles",
        "1 paralipomenon": "1 Chronicles",
        "2 paralipomenon": "2 Chronicles",
        "rev": "Revelation",
        "1 cor": "1 Corinthians",
        "2 cor": "2 Corinthians",
        "1 co": "1 Corinthians",
        "2 co": "2 Corinthians",
        "isa": "Isaiah",
        "isaias": "Isaiah",
        "mic": "Micah",
        "micheas": "Micah",
        "ho": "Hosea",
        "hos": "Hosea",
        "osee": "Hosea",
        "jer": "Jeremiah",
        "zeph": "Zephaniah",
        "sophonias": "Zephaniah",
        "hab": "Habakkuk",
        "habakkuk": "Habakkuk",
        "hahakkuk": "Habakkuk",
        "da": "Daniel",
        "dan": "Daniel",
        "deut": "Deuteronomy",
        "de": "Deuteronomy",
        "rom": "Romans",
        "col": "Colossians",
        "josh": "Joshua",
        "jos": "Joshua",
        "1 thess": "1 Thessalonians",
        "2 thess": "2 Thessalonians",
        "1 thes": "1 Thessalonians",
        "2 thes": "2 Thessalonians",
        "1 thcss": "1 Thessalonians",
        "2 thcss": "2 Thessalonians",
        "1 thcs": "1 Thessalonians",
        "2 thcs": "2 Thessalonians",
        "1 th": "1 Thessalonians",
        "2 th": "2 Thessalonians",
        "1 sam": "1 Samuel",
        "2 sam": "2 Samuel",
        "1 sa": "1 Samuel",
        "2 sa": "2 Samuel",
        "judg": "Judges",
        "jg": "Judges",
        "eph": "Ephesians",
        "nah": "Nahum",
        "pr": "Proverbs",
        "phil": "Philippians",
        "php": "Philippians",
        "phm": "Philemon",
        "philemon": "Philemon",
        "philem": "Philemon",
        "gal": "Galatians",
        "ga": "Galatians",
        "gn": "Galatians",
        "heb": "Hebrews",
        "num": "Numbers",
        "mal": "Malachi",
        "tit": "Titus",
        "obad": "Obadiah",
        "es": "Esther",
        "esth": "Esther",
        "1 ki": "1 Kings",
        "2 ki": "2 Kings",
        "joe": "Joseph",
//"{  ,
        "neh": "Nehemiah",
        "ne": "Nehemiah",
        "re": "Revelation",
        "eze": "Ezekiel",
        "ezech": "Ezekiel",
        "ezechiel": "Ezekiel",
        "ge": "Genesis",
        "ac": "Acts",
        "act": "Acts",
        "ro": "Romans",
        "lu": "Luke",
        "lk": "Luke",
        "joh": "John",
        "jon": "John",
        "jn": "John",
        "jno": "John",
        "jo": "John",
        "1 john": "1 John",
        "2 john": "2 John",
        "3 john": "3 John",
        "1 joh": "1 John",
        "2 joh": "2 John",
        "3 joh": "3 John",
        "1 jo": "1 John",
        "2 jo": "2 John",
        "3 jo": "3 John",
        "1 jn": "1 John",
        "2 jn": "2 John",
        "3 jn": "3 John",
        "1 jon": "1 John",
        "2 jon": "2 John",
        "3 jon": "3 John",
        "1 jno": "1 John",
        "2 jno": "2 John",
        "3 jno": "3 John",
        "nu": "Numbers",
        "job": "Job",
        "mark": "Mark",
        "joel": "Joel",
        "amos": "Amos",
        "zep": "Zephaniah",
        "1 pe": "1 Peter",
        "2 pe": "2 Peter",
        "1 pet": "1 Peter",
        "2 pet": "2 Peter",
        "sura": "Sura",
        "suras": "Sura",
        "jona": "Jonah",
        "ruth": "Ruth",
        "ca": "Solomon",
        "cant": "Solomon",
        "sol": "Solomon",
        "1 macc": "1 Maccabees",
        "2 macc": "2 Maccabees",
        "1 machabees": "1 Maccabees",
        "2 machabees": "2 Maccabees",
        "wisdom": "Wisdom",
        "lam": "Lamentations",
        "la": "Lamentations",
        "mormon": "Mormon",
        "moroni": "Moroni",
        "ether": "Ether",
        "apoc": "Apocalypse",
        "mosiah": "Mosiah",
        "alma": "Alma",
        "1 nephi": "1 Nephi",
        "2 nephi": "2 Nephi",
        "3 nephi": "3 Nephi",
        "helaman": "Helaman",
        "apostles": "Acts",

        "to": "",
        "at": "",
        "and": "",
        "around": "",
        "about": "",
        "between": "",
        "until": "",
        "by": "",
        "was": "",
        "from": "",
        "till": "",
        "through": "",
        "vs": "",
        "ver": "",
        "no": "",
    };
}